---

- hosts: all
  sudo: yes
  vars:
    citadel_bucket: 'balanced-citadel'
    rabbitmq_vhosts:
      - localhost
    redis_bind: 127.0.0.1
    postgresql_ext_install_contrib: yes
    postgresql_client_encoding: utf8

  vars_files:
    - defaults/main.yml

  roles:
    - base
    - postgresql
    - rabbitmq
    - redis

  handlers:
    - include: handlers/main.yml

  tasks:
    - name: PostgreSQL | add {{ app_name }} as a super user
      tags: setup-db
      postgresql_user: >-
        name="{{ app_name }}"
        password="{{ app_name }}"
        encrypted=no
        role_attr_flags=SUPERUSER
        login_host=localhost
        state=present
      ignore_errors: yes

    - name: PostgreSQL | create the {{ app_name }} db
      tags: setup-db
      postgresql_db: >-
        name="{{ app_name }}"
        owner="{{ app_name }}"
        encoding=UTF-8
        lc_collate='en_US.UTF-8'
        lc_ctype='en_US.UTF-8'
        template=template0
        login_host=localhost
        login_user="{{ app_name }}"
        login_password="{{ app_name }}"
        state=present

    - name: Fetch deploy key?
      debug: msg="{{ lookup('citadel', '/deploy_key/deploy.pem') }}"
      tags: citadel

    - name: Write the deploy key for cloning
      tags: deploy-key
      sudo: false
      lineinfile:
        dest=~/.ssh/deploy_key
        line="{{ lookup('citadel', '/deploy_key/deploy.pem') }}"
        state=present
        create=yes
        mode='0400'

    # http://hakunin.com/six-ansible-practices
    - name: ensure github.com is a known host
      tags: balanced-install
      lineinfile:
        dest: /root/.ssh/known_hosts
        create: yes
        state: present
        line: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com') }}"
        regexp: "^github\\.com"

    - name: install pip dirs for vagrant user
      include: roles/base/tasks/py.yml
      tags: balanced-install-development
      vars:
        users:
          - name: vagrant
        pypi_scheme: https
        pypi_username: omnibus
        pypi_password: "{{ lookup('citadel', '/omnibus/devpi_password').strip() }}"
        pypi_host: pypi.vandelay.io
        pypi_index: /balanced/prod/+simple/

    - name: install {{ app_name }}
      sudo: no
      include: tasks/development.yml
      tags: "{{ app_name }}-install"
      vars:
        app_install_method: git
        app_apt_version: null
        app_git_repo: ssh://git@github.com/balanced/{{ app_name }}.git
        app_git_version: master

    - name: install balanced development tools
      include: tasks/development.yml
      tags: balanced-install-development
